
trigger:
- main
- develop
- master

variables:
  buildConfiguration: 'Release'
  nodeVersion: '18.x'

steps:
- checkout: self
  fetchDepth: 0
  displayName: 'ğŸ“¥ Checkout Repository'

- task: NodeTool@0
  inputs:
    versionSpec: '$(nodeVersion)'
  displayName: 'ğŸŸ¢ Install Node.js $(nodeVersion)'

- script: npm ci
  displayName: 'ğŸ“¦ Install Dependencies'

- script: npm run format
  displayName: 'ğŸ¨ Format Code (Prettier)'
  continueOnError: true

- script: npm run lint
  displayName: 'ğŸ” Lint Code (ESLint)'
  continueOnError: false

- script: npm run test:unit
  displayName: 'ğŸ§ª Run Unit Tests'

- script: npm run test:cov:ci
  displayName: 'ğŸ“Š Run Tests with Coverage'
  env:
    JEST_JUNIT_OUTPUT_DIR: 'coverage'
    JEST_JUNIT_OUTPUT_NAME: 'junit.xml'

- script: npm run build
  displayName: 'ğŸ—ï¸ Build Application'

- script: npm run test:e2e
  displayName: 'ğŸ”„ Run E2E Tests'
  continueOnError: true

- task: PublishCodeCoverageResults@2
  condition: succeededOrFailed()
  inputs:
    summaryFileLocation: 'coverage/cobertura-coverage.xml'
    pathToSources: 'src'
    failIfCoverageEmpty: false
  displayName: 'ğŸ“ˆ Publish Coverage Results'

- task: PublishTestResults@2
  condition: succeededOrFailed()
  inputs:
    testRunner: 'JUnit'
    testResultsFiles: 'coverage/junit.xml'
    mergeTestResults: true
    failTaskOnFailedTests: false
  displayName: 'ğŸ“‹ Publish Test Results'